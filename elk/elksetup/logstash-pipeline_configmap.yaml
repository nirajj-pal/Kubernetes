apiVersion: v1
data:
  logstash.conf: |
    input {
      beats { port => 5044 }
    }

    filter {
      # --------------------------
      # Choose namespace (client -> cluster -> default)
      # --------------------------
      if [client] and [client] != "" {
        mutate { add_field => { "[@metadata][ds_namespace]" => "%{[client]}" } }
      } else if [orchestrator][cluster][name] and [orchestrator][cluster][name] != "" {
        mutate { add_field => { "[@metadata][ds_namespace]" => "%{[orchestrator][cluster][name]}" } }
      } else if [cluster][name] and [cluster][name] != "" {
        mutate { add_field => { "[@metadata][ds_namespace]" => "%{[cluster][name]}" } }
      } else {
        mutate { add_field => { "[@metadata][ds_namespace]" => "default" } }
      }

      # keep it safe for datastream/index naming
      mutate {
        lowercase => ["[@metadata][ds_namespace]"]
        gsub => ["[@metadata][ds_namespace]", "[^a-z0-9_-]", "-"]
      }

      # --------------------------
      # METRICS (metricbeat)
      # --------------------------
      if [@metadata][beat] == "metricbeat" {
        mutate {
          add_field => {
            "[data_stream][type]"      => "metrics"
            "[data_stream][dataset]"   => "kubernetes"
            "[data_stream][namespace]" => "%{[@metadata][ds_namespace]}"
          }
        }
      }
      # --------------------------
      # LOGS (filebeat)
      # --------------------------
      else {
        if [kubernetes] {
          mutate { add_field => { "[@metadata][ds_dataset]" => "kubernetes.container" } }

          # ---- KEY FIX: prevent mapping explosion ----
          # labels + annotations create massive numbers of fields in Elasticsearch,
          # which makes Kibana slow (field_caps, autocomplete, Lens suggestions, etc.)
          mutate {
            remove_field => [
              "[kubernetes][labels]",
              "[kubernetes][annotations]"
            ]
          }

        } else if [log][file][path] =~ "^/var/log/" {
          mutate { add_field => { "[@metadata][ds_dataset]" => "system.syslog" } }
        } else {
          drop { }
        }

        mutate {
          add_field => {
            "[data_stream][type]"      => "logs"
            "[data_stream][dataset]"   => "%{[@metadata][ds_dataset]}"
            "[data_stream][namespace]" => "%{[@metadata][ds_namespace]}"
          }
        }
      }
    }

    output {
      elasticsearch {
        hosts => ["https://elasticsearch-master:9200"]
        user => "${ELASTIC_USERNAME}"
        password => "${ELASTIC_PASSWORD}"
        ssl => true
        cacert => "/usr/share/logstash/config/certs/ca.crt"

        ecs_compatibility => "v8"
        data_stream => true
      }

      # stdout { codec => rubydebug }  # enable only for debugging
    }
kind: ConfigMap
metadata:
  name: logstash-pipeline
  namespace: elk
